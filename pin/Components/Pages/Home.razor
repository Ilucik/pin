@page "/"
@using Microsoft.Extensions.Configuration
@using pin.Infrastructure
@inject IConfiguration config
@inject IWritableOptions<UserOptions> writableConfig
@if (homeDirecory is null || homeDirecory.HomeDirectory is null)
{
    <SelectHomeDirectory OnClickCallback="Load" />
}
@if (directories is not null)
{
    <Images homeDirecory="@homeDirecory.HomeDirectory" directories="@directories" currentDirectory="@homeDirecory.HomeSubdirectory"/>
}

@code {
    private UserOptions homeDirecory;
    private IEnumerable<String> directories;

    protected override async Task OnInitializedAsync()
    {
        var section = config.GetSection(nameof(UserOptions));
        homeDirecory = section.Get<UserOptions>();
        // homeDirecory = @"C:/Users/super/Downloads/Новая папка";
        if(homeDirecory is not null && homeDirecory.HomeDirectory is not null)
            directories = LoadDirectories();

        await base.OnInitializedAsync();
    }


    private IEnumerable<String> LoadDirectories()
    {
        return (new DirectoryInfo(homeDirecory.HomeDirectory))
        .GetDirectories()
        .Select(e => e.Name);
    }

    private void Load(string path)
    {
        homeDirecory.HomeDirectory = path;
        writableConfig.Update(e => { 
            e.HomeDirectory = homeDirecory.HomeDirectory;
            e.HomeSubdirectory = homeDirecory.HomeSubdirectory; });
        directories = LoadDirectories();
    }
}
